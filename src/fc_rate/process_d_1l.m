clc
clear

format short

is_octave = exist('OCTAVE_VERSION', 'builtin') ~= 0;

if is_octave
    warning('off', 'all'); % suppress octave warnings
end

logfile = 'process_d_1l.log';

if exist(logfile, 'file') == 2
    delete(logfile);
end

diary(logfile)

nmix = 171;
ngrps = 13;
ngrpd = 2;
nbnus = 4;

filedir = fileparts(mfilename('fullpath'));
dpath = '/../../Dragon/1L/ASSBLY_D/output_2020-09-04_15-51-08/';
spath = '/../../Serpent/ASSBLY_D/output_2020-08-23_12-21-57/';

s(1).drag_filename = fullfile(filedir, dpath, 'ASSBLY_CASED_R_BCOND2.txt');
s(1).serp_filename = fullfile(filedir, spath, 'ASSBLY_CASED_mc_det0.m');
s(1).serp_dep_filename = fullfile(filedir, spath, 'ASSBLY_CASED_mc_dep.m');
s(1).results_fission = fullfile(filedir, dpath, 'process_dfm_first.result');
s(1).results_capture = fullfile(filedir, dpath, 'process_dcm_first.result');

s(2).drag_filename = fullfile(filedir, dpath, 'ASSBLY_CASED_R_BCOND2_PEAK.txt');
s(2).serp_filename = fullfile(filedir, spath, 'ASSBLY_CASED_mc_det73.m');
s(2).serp_dep_filename = fullfile(filedir, spath, 'ASSBLY_CASED_mc_dep.m');
s(2).results_fission = fullfile(filedir, dpath, 'process_dfm_peak.result');
s(2).results_capture = fullfile(filedir, dpath, 'process_dcm_peak.result');

s(3).drag_filename = fullfile(filedir, dpath, 'ASSBLY_CASED_R_BCOND2_LAST.txt');
s(3).serp_filename = fullfile(filedir, spath, 'ASSBLY_CASED_mc_det107.m');
s(3).serp_dep_filename = fullfile(filedir, spath, 'ASSBLY_CASED_mc_dep.m');
s(3).results_fission = fullfile(filedir, dpath, 'process_dfm_last.result');
s(3).results_capture = fullfile(filedir, dpath, 'process_dcm_last.result');

gd_cells = {'C0301', 'C0505', 'C0601', 'C0707', 'C0804'};

det_map = struct( ...
    'C0201', 1, ...
    'C0202', 2, ...
    'C0301', 3, ...
    'C0302', 4, ...
    'C0303', 5, ...
    'C0402', 6, ...
    'C0403', 7, ...
    'C0501', 8, ...
    'C0502', 9, ...
    'C0503', 10, ...
    'C0504', 11, ...
    'C0505', 12, ...
    'C0601', 13, ...
    'C0602', 14, ...
    'C0603', 15, ...
    'C0604', 16, ...
    'C0605', 17, ...
    'C0702', 18, ...
    'C0703', 19, ...
    'C0705', 20, ...
    'C0706', 21, ...
    'C0707', 22, ...
    'C0801', 23, ...
    'C0802', 24, ...
    'C0803', 25, ...
    'C0804', 26, ...
    'C0805', 27, ...
    'C0806', 28, ...
    'C0807', 29, ...
    'C0808', 30, ...
    'C0901', 31, ...
    'C0902', 32, ...
    'C0903', 33, ...
    'C0904', 34, ...
    'C0905', 35, ...
    'C0906', 36, ...
    'C0907', 37, ...
    'C0908', 38, ...
    'C0909', 39 ...
    );

hname = { ...
    '***********', '***********', ...
    'DET_C0201_A', 'DET_C0201_B', 'DET_C0201_C', 'DET_C0201_D', ...
    '***********', '***********', ...
    'DET_C0202_A', 'DET_C0202_B', 'DET_C0202_C', 'DET_C0202_D', ...
    'DET_C0301_A', 'DET_C0301_B', 'DET_C0301_C', 'DET_C0301_D', 'DET_C0301_E', 'DET_C0301_F', ...
    'DET_C0302_A', 'DET_C0302_B', 'DET_C0302_C', 'DET_C0302_D', ...
    'DET_C0303_A', 'DET_C0303_B', 'DET_C0303_C', 'DET_C0303_D', ...
    '***********', ...
    'DET_C0402_A', 'DET_C0402_B', 'DET_C0402_C', 'DET_C0402_D', ...
    'DET_C0403_A', 'DET_C0403_B', 'DET_C0403_C', 'DET_C0403_D', ...
    'DET_C0501_A', 'DET_C0501_B', 'DET_C0501_C', 'DET_C0501_D', ...
    'DET_C0502_A', 'DET_C0502_B', 'DET_C0502_C', 'DET_C0502_D', ...
    'DET_C0503_A', 'DET_C0503_B', 'DET_C0503_C', 'DET_C0503_D', ...
    'DET_C0504_A', 'DET_C0504_B', 'DET_C0504_C', 'DET_C0504_D', ...
    'DET_C0505_A', 'DET_C0505_B', 'DET_C0505_C', 'DET_C0505_D', 'DET_C0505_E', 'DET_C0505_F', ...
    'DET_C0601_A', 'DET_C0601_B', 'DET_C0601_C', 'DET_C0601_D', 'DET_C0601_E', 'DET_C0601_F', ...
    'DET_C0602_A', 'DET_C0602_B', 'DET_C0602_C', 'DET_C0602_D', ...
    'DET_C0603_A', 'DET_C0603_B', 'DET_C0603_C', 'DET_C0603_D', ...
    'DET_C0604_A', 'DET_C0604_B', 'DET_C0604_C', 'DET_C0604_D', ...
    'DET_C0605_A', 'DET_C0605_B', 'DET_C0605_C', 'DET_C0605_D', ...
    'DET_C0702_A', 'DET_C0702_B', 'DET_C0702_C', 'DET_C0702_D', ...
    'DET_C0703_A', 'DET_C0703_B', 'DET_C0703_C', 'DET_C0703_D', ...
    'DET_C0705_A', 'DET_C0705_B', 'DET_C0705_C', 'DET_C0705_D', ...
    'DET_C0706_A', 'DET_C0706_B', 'DET_C0706_C', 'DET_C0706_D', ...
    'DET_C0707_A', 'DET_C0707_B', 'DET_C0707_C', 'DET_C0707_D', 'DET_C0707_E', 'DET_C0707_F', ...
    'DET_C0801_A', 'DET_C0801_B', 'DET_C0801_C', 'DET_C0801_D', ...
    'DET_C0802_A', 'DET_C0802_B', 'DET_C0802_C', 'DET_C0802_D', ...
    'DET_C0803_A', 'DET_C0803_B', 'DET_C0803_C', 'DET_C0803_D', ...
    'DET_C0804_A', 'DET_C0804_B', 'DET_C0804_C', 'DET_C0804_D', 'DET_C0804_E', 'DET_C0804_F', ...
    'DET_C0805_A', 'DET_C0805_B', 'DET_C0805_C', 'DET_C0805_D', ...
    'DET_C0806_A', 'DET_C0806_B', 'DET_C0806_C', 'DET_C0806_D', ...
    'DET_C0807_A', 'DET_C0807_B', 'DET_C0807_C', 'DET_C0807_D', ...
    'DET_C0808_A', 'DET_C0808_B', 'DET_C0808_C', 'DET_C0808_D', ...
    'DET_C0901_A', 'DET_C0901_B', 'DET_C0901_C', 'DET_C0901_D', ...
    'DET_C0902_A', 'DET_C0902_B', 'DET_C0902_C', 'DET_C0902_D', ...
    'DET_C0903_A', 'DET_C0903_B', 'DET_C0903_C', 'DET_C0903_D', ...
    'DET_C0904_A', 'DET_C0904_B', 'DET_C0904_C', 'DET_C0904_D', ...
    'DET_C0905_A', 'DET_C0905_B', 'DET_C0905_C', 'DET_C0905_D', ...
    'DET_C0906_A', 'DET_C0906_B', 'DET_C0906_C', 'DET_C0906_D', ...
    'DET_C0907_A', 'DET_C0907_B', 'DET_C0907_C', 'DET_C0907_D', ...
    'DET_C0908_A', 'DET_C0908_B', 'DET_C0908_C', 'DET_C0908_D', ...
    'DET_C0909_A', 'DET_C0909_B', 'DET_C0909_C', 'DET_C0909_D', ...
    };

merge = [ ...
    0, 0, 1, 1, 1, 1, 0, 0, 2, 2, 2, 2, 3, 3, 3, 3, ...
    3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 0, 6, 6, 6, 6, 7, ...
    7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 9, 10, 10, 10, 10, 11, ...
    11, 11, 11, 12, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13, 13, 14, ...
    14, 14, 14, 15, 15, 15, 15, ...
    16, 16, 16, 16, 17, 17, 17, 17, 18, 18, 18, 18, 19, 19, 19, 19, ...
    20, 20, 20, 20, 21, 21, 21, 21, 22, 22, 22, 22, 22, 22, 23, 23, ...
    23, 23, 24, 24, 24, 24, 25, 25, 25, 25, 26, 26, 26, 26, 26, 26, ...
    27, 27, 27, 27, 28, 28, 28, 28, 29, 29, 29, 29, 30, 30, 30, 30, ...
    31, 31, 31, 31, ...
    32, 32, 32, 32, 33, 33, 33, 33, 34, 34, 34, 34, 35, 35, 35, 35, ...
    36, 36, 36, 36, 37, 37, 37, 37, 38, 38, 38, 38, 39, 39, 39, 39, ...
    ];

for i = 1:numel(s)
    
    %% parse dragon5 output
    
    [nfmd, ngmd, prod, nfall_d, ngall_d, nftot_d_1g, ngtot_d_1g] = ...
        parse_dragon(nmix, ngrpd, nbnus, s(i).drag_filename);
    
    %% save dragon data
    
    mat_filename = fullfile(filedir, '..', '..', 'data', sprintf('parse_dragon_d_1l_%02d.mat', i));
    out_folder = fileparts(mat_filename);
    
    if ~exist(fullfile(out_folder), 'dir')
        mkdir(fullfile(out_folder))
    end

    save(mat_filename, 'nfmd', 'ngmd', 'prod', 'nfall_d', 'ngall_d', 'nftot_d_1g', 'ngtot_d_1g', '-v7');
    %load(mat_filename)
    
    %% parse serpent2 output
    
    [nfms, ngms, nfall_s, ngall_s, nftot_s_1g, ngtot_s_1g] = ...
        parse_serpent(nmix, ngrps, ngrpd, nbnus, hname, det_map, ...
        gd_cells, s(i).serp_filename, s(i).serp_dep_filename);
    %% compare fission reaction rates
    
    report_fission(nmix, merge, ngrpd, nbnus, nfall_s, nfall_d, prod, ...
        nftot_s_1g, nftot_d_1g, nfms, nfmd, s(i).results_fission);
    %% compare capture reaction rates
    
    report_capture(nmix, merge, ngrpd, nbnus, ngall_s, ngall_d, prod, ...
        ngtot_s_1g, ngtot_d_1g, ngms, ngmd, s(i).results_capture);
    
end

diary off
